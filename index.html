<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Realtime Chat + Friends + Video</title>
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --muted: #6b7280;
      --text: #e5e7eb; --accent: #22c55e; --warn: #ef4444; --info:#3b82f6;
      --border: #1f2937; --focus:#93c5fd;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif;
      background: linear-gradient(180deg, #0b1023, #0f172a);
      color: var(--text);
    }
    header, footer {
      padding: 12px 16px; background: #0b1222; border-bottom: 1px solid var(--border);
    }
    header h1 { margin: 0; font-size: 18px; }
    .container {
      display: grid; grid-template-columns: 300px 1fr; gap: 12px;
      padding: 12px; height: calc(100vh - 88px);
    }
    .panel {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 10px; overflow: hidden;
    }
    .panel h2 {
      margin: 0; padding: 12px 12px; font-size: 14px;
      border-bottom: 1px solid var(--border); color: var(--muted);
    }
    .stack { display: grid; gap: 10px; padding: 12px; }
    input, button, select, textarea {
      border-radius: 8px; border: 1px solid var(--border);
      background: #0f172a; color: var(--text); padding: 10px; font-size: 14px;
    }
    input:focus, button:focus { outline: 2px solid var(--focus); outline-offset: 2px; }
    button.accent { background: var(--accent); color: #042010; border-color: #16a34a; }
    button.warn { background: var(--warn); border-color: #b91c1c; }
    button.info { background: var(--info); border-color: #2563eb; color:#062042; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.loading::after {
      content: '...'; margin-left: 6px; animation: pulse 1s infinite;
    }
    @keyframes pulse { 0%{opacity:.3} 50%{opacity:1} 100%{opacity:.3} }
    .row { display: flex; gap: 10px; align-items: center; }
    .grow { flex: 1; }
    .muted { color: var(--muted); font-size: 12px; }
    .list { max-height: 40vh; overflow: auto; display: grid; gap: 6px; }
    .item {
      display: grid; grid-template-columns: 1fr auto; gap: 6px; align-items: center;
      padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: #0b1428;
    }
    .item .name { font-weight: 600; }
    .chat {
      display: grid; grid-template-rows: auto 1fr auto auto; height: 100%;
    }
    .messages { overflow-y: auto; padding: 12px; display: grid; gap: 8px; }
    .bubble {
      max-width: 70%; padding: 10px; border-radius: 12px;
      background: #0b1428; border: 1px solid var(--border); word-wrap: break-word;
    }
    .bubble.me { justify-self: end; background: #0e2b17; border-color: #14532d; }
    .bubble .meta { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .compose { padding: 10px; display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    .callbar { padding: 8px; border-top: 1px solid var(--border); display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    video { width: 48%; max-height: 30vh; background: #000; border-radius: 8px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; height: auto; min-height: calc(100vh - 88px); }
      .list { max-height: none; }
      video { width: 100%; max-height: 35vh; }
    }
    #toast {
      position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%);
      background: #0b1428; border:1px solid var(--border); border-radius:10px;
      padding: 8px 12px; color: var(--text); display:none; z-index: 100;
    }
    #loginOverlay { position: fixed; inset: 0; background: rgba(5,10,25,0.9); display: grid; place-items: center; z-index: 20; }
    #loginCard { width: min(520px, 94vw); background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: grid; gap: 12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#0b1428; padding:2px 6px; border-radius:6px; }
    .pill { font-size: 12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#0b1428; }
  </style>
</head>
<body>

<header>
  <h1>Chat + Friends + Video</h1>
</header>

<!-- Login -->
<div id="loginOverlay" aria-modal="true" role="dialog">
  <div id="loginCard">
    <h2>เข้าสู่ระบบด้วยชื่อ + PIN</h2>
    <div class="stack">
      <div class="row">
        <input id="username" class="grow" placeholder="เช่น asus" autocomplete="username" />
      </div>
      <div class="row">
        <input id="pin" class="grow" placeholder="PIN 6 หลัก" inputmode="numeric" maxlength="6" />
        <button id="loginBtn" class="accent">เข้าสู่ระบบ</button>
      </div>
      <p class="muted">
        กดเข้าสู่ระบบหรือสร้างบัญชีสำเร็จแล้วจะไปหน้าหลักทันที. แชร์บัญชีไปยังอุปกรณ์อื่นได้ด้วย Pair code.
      </p>
      <div class="row">
        <button id="createBtn" class="info">สร้างบัญชีใหม่</button>
        <span id="loginStatus" class="muted"></span>
      </div>
    </div>
  </div>
</div>

<div class="container" aria-live="polite">
  <!-- Left: friends and requests -->
  <section class="panel">
    <h2>เพื่อนและคำขอ</h2>
    <div class="stack">
      <div class="row">
        <input id="searchUser" class="grow" placeholder="ค้นหาชื่อเพื่อแอดเพื่อน" />
        <button id="addFriendBtn">แอดเพื่อน</button>
      </div>
      <div class="row">
        <button id="refreshFriendsBtn" class="info">รีเฟรชเพื่อน</button>
        <span id="friendsCount" class="pill">0 เพื่อน</span>
      </div>
      <div>
        <div class="muted">เพื่อน</div>
        <div id="friendsList" class="list" aria-label="รายชื่อเพื่อน"></div>
      </div>
      <div>
        <div class="muted">คำขอที่เข้ามา</div>
        <div id="requestsList" class="list" aria-label="คำขอเพื่อน"></div>
      </div>

      <h2>แชร์บัญชี (Pair code)</h2>
      <div class="stack">
        <div class="row">
          <button id="genPairCodeBtn" class="accent">สร้าง Pair code</button>
          <span id="pairCodeLabel" class="kbd"></span>
        </div>
        <div class="row">
          <input id="pairCodeInput" class="grow" placeholder="กรอกรหัสเพื่อเชื่อมบัญชีนี้บนอุปกรณ์อื่น" />
          <button id="usePairCodeBtn" class="info">ใช้รหัส</button>
        </div>
        <p class="muted">รหัสใช้ครั้งเดียว หมดอายุใน 5 นาที</p>
      </div>

      <div class="row">
        <button id="logoutBtn" class="warn">ออกจากระบบ</button>
        <span class="muted">UID: <span id="uidLabel" class="kbd"></span></span>
      </div>
    </div>
  </section>

  <!-- Right: chat -->
  <section class="panel chat" aria-label="พื้นที่แชท">
    <h2 id="chatTitle">เลือกเพื่อนเพื่อเริ่มแชท</h2>
    <div id="messages" class="messages"></div>
    <div class="compose">
      <input id="messageInput" placeholder="พิมพ์ข้อความ..." />
      <button id="sendBtn" class="accent">ส่ง</button>
    </div>
    <div class="callbar">
      <div class="toolbar">
        <button id="startCallBtn">เริ่มวีดีโอคอล</button>
        <button id="hangupBtn" class="warn" disabled>วางสาย</button>
        <span id="callStatus" class="muted">พร้อมคุย</span>
      </div>
      <div class="toolbar" style="margin-left:auto">
        <button id="muteBtn">ปิด/เปิดไมค์</button>
        <button id="cameraBtn">ปิด/เปิดกล้อง</button>
      </div>
    </div>
    <div class="row" style="padding:8px">
      <video id="localVideo" autoplay playsinline muted></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>
  </section>
</div>

<footer>
  <span class="muted">บันทึกทุกอย่างแบบเรียลไทม์ ปลอดภัย และรองรับมือถือ</span>
</footer>

<div id="toast"></div>

<script type="module">
  // ===== Firebase bootstrap =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getDatabase, ref, get, set, push, onValue, onChildAdded,
    update, runTransaction, onDisconnect, remove
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import {
    getAuth, onAuthStateChanged, signInAnonymously, signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "YOUR-API-KEY",
    authDomain: "YOUR-PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR-PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "YOUR-PROJECT",
    storageBucket: "YOUR-PROJECT.appspot.com",
    messagingSenderId: "YOUR-SENDER-ID",
    appId: "YOUR-APP-ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // ===== DOM refs =====
  const loginOverlay = document.getElementById('loginOverlay');
  const usernameInput = document.getElementById('username');
  const pinInput = document.getElementById('pin');
  const loginBtn = document.getElementById('loginBtn');
  const createBtn = document.getElementById('createBtn');
  const loginStatus = document.getElementById('loginStatus');

  const searchUserInput = document.getElementById('searchUser');
  const addFriendBtn = document.getElementById('addFriendBtn');
  const refreshFriendsBtn = document.getElementById('refreshFriendsBtn');
  const friendsCount = document.getElementById('friendsCount');
  const friendsList = document.getElementById('friendsList');
  const requestsList = document.getElementById('requestsList');

  const chatTitle = document.getElementById('chatTitle');
  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const uidLabel = document.getElementById('uidLabel');

  const startCallBtn = document.getElementById('startCallBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const callStatus = document.getElementById('callStatus');
  const muteBtn = document.getElementById('muteBtn');
  const cameraBtn = document.getElementById('cameraBtn');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  const genPairCodeBtn = document.getElementById('genPairCodeBtn');
  const pairCodeLabel = document.getElementById('pairCodeLabel');
  const pairCodeInput = document.getElementById('pairCodeInput');
  const usePairCodeBtn = document.getElementById('usePairCodeBtn');

  const toastEl = document.getElementById('toast');

  // ===== State =====
  let currentUser = { uid: null, name: null };
  let currentChatPeer = null;
  let currentChatId = null;

  // WebRTC state
  let pc = null;
  let localStream = null;
  const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  // ===== Utilities =====
  const chatIdFor = (a, b) => [a, b].sort().join('_');
  const userRef = (uid) => ref(db, `users/${uid}`);
  const usernameIndexRef = (name) => ref(db, `usernames/${name.toLowerCase()}`);
  const credsRef = (name) => ref(db, `creds/${name.toLowerCase()}`); // { pinHash, uid }
  const friendsRef = (uid) => ref(db, `friends/${uid}`);
  const requestsRef = (uid) => ref(db, `friendRequests/${uid}`);
  const chatRef = (chatId) => ref(db, `chats/${chatId}/messages`);
  const presenceRef = (uid) => ref(db, `presence/${uid}`);
  const pairCodeRef = (code) => ref(db, `pairCodes/${code}`);
  const callsBaseRef = (chatId) => ref(db, `calls/${chatId}`);

  const fmt = (ts) => { try { return new Date(ts).toLocaleString(); } catch { return '' } };
  const withLoading = async (btn, fn) => {
    const oldDisabled = btn.disabled;
    btn.disabled = true; btn.classList.add('loading');
    try { return await fn(); } finally { btn.disabled = oldDisabled; btn.classList.remove('loading'); }
  };
  const showToast = (msg, ms=1800) => {
    toastEl.textContent = msg; toastEl.style.display = 'block';
    setTimeout(() => { toastEl.style.display = 'none'; }, ms);
  };
  const hashPIN = async (pin) => {
    const enc = new TextEncoder().encode(pin);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  };

  const startAnonymous = async () => {
    await signInAnonymously(auth);
    return new Promise((resolve) => {
      const unsub = onAuthStateChanged(auth, async (u) => {
        if (!u) return;
        currentUser.uid = u.uid;
        uidLabel.textContent = currentUser.uid;
        resolve(true);
        unsub();
      });
    });
  };

  // ===== Account creation and login (instant transition) =====
  const createAccount = async (name, pin) => {
    const uname = name.trim().toLowerCase();
    if (!uname || !pin || pin.length < 4) { showToast('กรอกชื่อและ PIN อย่างน้อย 4 หลัก'); return false; }
    const pinHash = await hashPIN(pin);

    const tx = await runTransaction(usernameIndexRef(uname), (cur) => {
      if (cur === null) return { reservedAt: Date.now() };
      return cur;
    });
    if (!tx.committed || (tx.snapshot.val() && tx.snapshot.val().uid)) {
      showToast('ชื่อนี้มีคนใช้แล้ว'); return false;
    }

    await startAnonymous();
    await set(userRef(currentUser.uid), { displayName: name.trim(), createdAt: Date.now(), lastChatPeer: null });
    await set(credsRef(uname), { pinHash, uid: currentUser.uid, at: Date.now() });
    await update(usernameIndexRef(uname), { uid: currentUser.uid });
    await set(presenceRef(currentUser.uid), { online: true, lastSeen: Date.now() });
    onDisconnect(presenceRef(currentUser.uid)).set({ online: false, lastSeen: Date.now() });

    currentUser.name = name.trim();

    // Instant transition
    loginOverlay.style.display = 'none';
    attachRealtimeListeners(true);
    showToast('สร้างบัญชีสำเร็จ');
    return true;
  };

  const loginAccount = async (name, pin) => {
    const uname = name.trim().toLowerCase();
    if (!uname || !pin) { showToast('กรอกชื่อและ PIN'); return false; }
    const pinHash = await hashPIN(pin);
    const cSnap = await get(credsRef(uname));
    const creds = cSnap.val();
    if (!creds) { showToast('ไม่พบบัญชีชื่อนี้'); return false; }
    if (creds.pinHash !== pinHash) { showToast('PIN ไม่ถูกต้อง'); return false; }

    await startAnonymous();
    currentUser.uid = creds.uid; // bind session to logical account
    const uSnap = await get(userRef(currentUser.uid));
    currentUser.name = uSnap.val()?.displayName || name.trim();
    uidLabel.textContent = currentUser.uid;

    await set(presenceRef(currentUser.uid), { online: true, lastSeen: Date.now() });
    onDisconnect(presenceRef(currentUser.uid)).set({ online: false, lastSeen: Date.now() });

    // Instant transition
    loginOverlay.style.display = 'none';
    attachRealtimeListeners(true);
    showToast('เข้าสู่ระบบสำเร็จ');
    return true;
  };

  // ===== Pair code (share account safely across devices) =====
  const genPairCode = async () => {
    if (!currentUser.uid) { showToast('โปรดเข้าสู่ระบบก่อน'); return; }
    const code = Math.random().toString().slice(2,8); // 6 digits
    await set(pairCodeRef(code), { uid: currentUser.uid, expireAt: Date.now() + 5*60*1000 });
    pairCodeLabel.textContent = code;
    showToast('สร้างรหัสสำเร็จ');
  };

  const usePairCode = async (code) => {
    if (!code) { showToast('กรอกรหัส Pair code'); return false; }
    const snap = await get(pairCodeRef(code));
    const data = snap.val();
    if (!data) { showToast('รหัสไม่ถูกต้อง'); return false; }
    if (Date.now() > data.expireAt) { showToast('รหัสหมดอายุ'); return false; }

    await startAnonymous();
    currentUser.uid = data.uid;
    const uSnap = await get(userRef(currentUser.uid));
    currentUser.name = uSnap.val()?.displayName || ('user_' + currentUser.uid.slice(-6));
    uidLabel.textContent = currentUser.uid;

    await set(presenceRef(currentUser.uid), { online: true, lastSeen: Date.now() });
    onDisconnect(presenceRef(currentUser.uid)).set({ online: false, lastSeen: Date.now() });

    // Instant transition
    loginOverlay.style.display = 'none';
    attachRealtimeListeners(true);
    await remove(pairCodeRef(code)); // consume
    showToast('เชื่อมบัญชีสำเร็จ');
    return true;
  };

  // ===== Friends and requests =====
  const renderListItem = (name, uid, actions = []) => {
    const div = document.createElement('div');
    div.className = 'item';
    const left = document.createElement('div');
    left.innerHTML = `<div class="name">${name}</div><div class="muted">${uid}</div>`;
    const right = document.createElement('div');
    actions.forEach(a => {
      const btn = document.createElement('button');
      btn.textContent = a.label;
      if (a.class) btn.classList.add(a.class);
      btn.onclick = async () => { await withLoading(btn, a.onClick); };
      right.appendChild(btn);
    });
    div.appendChild(left);
    div.appendChild(right);
    return div;
  };

  const attachRealtimeListeners = async (restore=false) => {
    // Clear lists
    friendsList.innerHTML = ''; requestsList.innerHTML = '';
    let count = 0;

    // Load last chat peer
    const u = await get(userRef(currentUser.uid));
    const lastPeer = u.val()?.lastChatPeer || null;

    // Requests
    onChildAdded(requestsRef(currentUser.uid), (snap) => {
      const fromUid = snap.key;
      get(userRef(fromUid)).then(s => {
        const name = s.val()?.displayName || fromUid.slice(-6);
        const item = renderListItem(name, fromUid, [
          { label: 'รับ', class: 'accent', onClick: () => acceptRequest(fromUid) },
          { label: 'ปฏิเสธ', class: 'warn', onClick: () => declineRequest(fromUid) },
        ]);
        item.dataset.uid = fromUid;
        requestsList.appendChild(item);
      });
    });

    // Friends
    onChildAdded(friendsRef(currentUser.uid), (snap) => {
      const peerUid = snap.key;
      const status = snap.val()?.status;
      if (status !== 'accepted') return;
      get(userRef(peerUid)).then(s => {
        const name = s.val()?.displayName || peerUid.slice(-6);
        const item = renderListItem(name, peerUid, [
          { label: 'แชท', class: 'accent', onClick: () => openChat(peerUid, name) },
          { label: 'ลบเพื่อน', class: 'warn', onClick: () => removeFriend(peerUid) },
        ]);
        item.dataset.uid = peerUid;
        friendsList.appendChild(item);
        count++; friendsCount.textContent = `${count} เพื่อน`;
        if (restore && lastPeer && lastPeer === peerUid) openChat(peerUid, name);
      });
    });
  };

  const sendFriendRequest = async (targetName) => {
    const qName = targetName.trim().toLowerCase();
    if (!qName) { showToast('กรุณากรอกชื่อเพื่อแอดเพื่อน'); return; }
    const idxSnap = await get(usernameIndexRef(qName));
    const idx = idxSnap.val();
    if (!idx?.uid) { showToast('ไม่พบผู้ใช้ชื่อนี้'); return; }
    if (idx.uid === currentUser.uid) { showToast('ไม่สามารถแอดตัวเองเป็นเพื่อนได้'); return; }
    await set(ref(db, `friendRequests/${idx.uid}/${currentUser.uid}`), { at: Date.now() });
    showToast('ส่งคำขอเพื่อนแล้ว');
  };

  const acceptRequest = async (fromUid) => {
    const me = currentUser.uid;
    await update(ref(db, `friends/${me}/${fromUid}`), { status: 'accepted', at: Date.now() });
    await update(ref(db, `friends/${fromUid}/${me}`), { status: 'accepted', at: Date.now() });
    await remove(ref(db, `friendRequests/${me}/${fromUid}`));
    showToast('เพิ่มเพื่อนสำเร็จ');
  };

  const declineRequest = async (fromUid) => {
    const me = currentUser.uid;
    await remove(ref(db, `friendRequests/${me}/${fromUid}`));
    showToast('ปฏิเสธคำขอแล้ว');
  };

  const removeFriend = async (peerUid) => {
    const me = currentUser.uid;
    await remove(ref(db, `friends/${me}/${peerUid}`));
    await remove(ref(db, `friends/${peerUid}/${me}`));
    if (currentChatPeer === peerUid) {
      currentChatPeer = null; currentChatId = null;
      chatTitle.textContent = 'เลือกเพื่อนเพื่อเริ่มแชท';
      messagesEl.innerHTML = '';
    }
    showToast('ลบเพื่อนแล้ว');
  };

  // ===== Chat =====
  const openChat = async (peerUid, peerName) => {
    currentChatPeer = peerUid;
    currentChatId = chatIdFor(currentUser.uid, peerUid);
    chatTitle.textContent = `คุยกับ ${peerName}`;
    messagesEl.innerHTML = '';
    await update(userRef(currentUser.uid), { lastChatPeer: peerUid });

    onValue(chatRef(currentChatId), (snap) => {
      messagesEl.innerHTML = '';
      const msgs = snap.val() || {};
      const sorted = Object.values(msgs).sort((a,b) => (a.at||0)-(b.at||0));
      sorted.forEach(m => {
        const b = document.createElement('div');
        b.className = 'bubble' + (m.from === currentUser.uid ? ' me' : '');
        b.innerHTML = `
          <div>${(m.text || '').replace(/</g,'&lt;')}</div>
          <div class="meta">${fmt(m.at)} • ${m.from === currentUser.uid ? 'ฉัน' : 'เขา'}</div>`;
        messagesEl.appendChild(b);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    });
  };

  const sendMessage = async () => {
    if (!currentChatId) { showToast('โปรดเลือกเพื่อนเพื่อเริ่มแชท'); return; }
    const text = messageInput.value.trim();
    if (!text) { showToast('พิมพ์ข้อความก่อนส่ง'); return; }
    await withLoading(sendBtn, async () => {
      await push(chatRef(currentChatId), { from: currentUser.uid, text, at: Date.now() });
      messageInput.value = '';
    });
  };

  // ===== WebRTC calls =====
  const setupPeer = () => {
    pc = new RTCPeerConnection(rtcConfig);
    pc.ontrack = (e) => { remoteVideo.srcObject = e.streams[0]; };
    pc.onicecandidate = (e) => {
      if (e.candidate && currentChatId) {
        push(ref(db, `calls/${currentChatId}/candidates/${currentUser.uid}`), e.candidate.toJSON());
      }
    };
    pc.onconnectionstatechange = () => {
      callStatus.textContent = pc.connectionState;
      if (['disconnected','failed','closed'].includes(pc.connectionState)) { hangupBtn.disabled = true; }
    };
  };

  const ensureMedia = async () => {
    if (localStream) return localStream;
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      return localStream;
    } catch {
      showToast('เปิดไมค์/กล้องไม่สำเร็จ'); throw new Error('media failed');
    }
  };

  const listenForCalls = () => {
    if (!currentChatId) return;
    const base = callsBaseRef(currentChatId);
    // Offers from peer
    onChildAdded(ref(db, `calls/${currentChatId}/offers`), async (snap) => {
      const offer = snap.val();
      if (offer.to !== currentUser.uid) return;
      await ensureMedia();
      setupPeer();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      await pc.setRemoteDescription(offer.sdp);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await push(ref(db, `calls/${currentChatId}/answers`), {
        from: currentUser.uid, to: offer.from, sdp: pc.localDescription, at: Date.now()
      });
      callStatus.textContent = 'กำลังเชื่อมต่อ...';
      hangupBtn.disabled = false;
      onChildAdded(ref(db, `calls/${currentChatId}/candidates/${offer.from}`), async (cSnap) => {
        const cand = cSnap.val(); try { await pc.addIceCandidate(cand); } catch {}
      });
    });

    // Answers to my offer
    onChildAdded(ref(db, `calls/${currentChatId}/answers`), async (snap) => {
      const ans = snap.val();
      if (ans.to !== currentUser.uid) return;
      await pc?.setRemoteDescription(ans.sdp);
      callStatus.textContent = 'เชื่อมต่อสำเร็จ';
      hangupBtn.disabled = false;
      onChildAdded(ref(db, `calls/${currentChatId}/candidates/${ans.from}`), async (cSnap) => {
        const cand = cSnap.val(); try { await pc.addIceCandidate(cand); } catch {}
      });
    });
  };

  const startCall = async () => {
    if (!currentChatPeer) { showToast('โปรดเปิดแชทกับเพื่อนก่อนเริ่มคอล'); return; }
    await withLoading(startCallBtn, async () => {
      await ensureMedia();
      setupPeer();
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await push(ref(db, `calls/${currentChatId}/offers`), {
        from: currentUser.uid, to: currentChatPeer, sdp: pc.localDescription, at: Date.now()
      });
      callStatus.textContent = 'ส่งคำเชิญคอล...';
      hangupBtn.disabled = false;
      listenForCalls();
    });
  };

  const hangup = async () => {
    await withLoading(hangupBtn, async () => {
      try { pc?.getSenders()?.forEach(s => s.track?.stop()); } catch {}
      try { pc?.close(); } catch {}
      pc = null; localStream = null;
      localVideo.srcObject = null; remoteVideo.srcObject = null;
      callStatus.textContent = 'พร้อมคุย';
      if (currentChatId) await remove(ref(db, `calls/${currentChatId}`));
    });
  };

  const toggleMic = () => {
    const tracks = localStream?.getAudioTracks() || [];
    tracks.forEach(t => t.enabled = !t.enabled);
    showToast(tracks.some(t => t.enabled) ? 'ไมค์เปิด' : 'ไมค์ปิด');
  };
  const toggleCam = () => {
    const tracks = localStream?.getVideoTracks() || [];
    tracks.forEach(t => t.enabled = !t.enabled);
    showToast(tracks.some(t => t.enabled) ? 'กล้องเปิด' : 'กล้องปิด');
  };

  // ===== Events =====
  loginBtn.onclick = () => withLoading(loginBtn, async () => {
    loginStatus.textContent = 'กำลังเข้าสู่ระบบ...';
    const ok = await loginAccount(usernameInput.value, pinInput.value);
    if (!ok) loginStatus.textContent = 'เข้าสู่ระบบไม่สำเร็จ';
    else loginStatus.textContent = '';
  });

  createBtn.onclick = () => withLoading(createBtn, async () => {
    loginStatus.textContent = 'กำลังสร้างบัญชี...';
    const ok = await createAccount(usernameInput.value, pinInput.value);
    if (!ok) loginStatus.textContent = 'สร้างบัญชีไม่สำเร็จ';
    else loginStatus.textContent = '';
  });

  addFriendBtn.onclick = () => withLoading(addFriendBtn, async () => {
    await sendFriendRequest(searchUserInput.value);
  });

  refreshFriendsBtn.onclick = async () => {
    friendsList.innerHTML = ''; friendsCount.textContent = '0 เพื่อน';
    attachRealtimeListeners();
    showToast('รีเฟรชรายชื่อเพื่อน');
  };

  sendBtn.onclick = sendMessage;
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  logoutBtn.onclick = async () => {
    await withLoading(logoutBtn, async () => {
      await signOut(auth);
      if (currentUser.uid) await set(presenceRef(currentUser.uid), { online: false, lastSeen: Date.now() });
      loginOverlay.style.display = 'grid';
      showToast('ออกจากระบบแล้ว');
    });
  };

  startCallBtn.onclick = startCall;
  hangupBtn.onclick = hangup;
  muteBtn.onclick = toggleMic;
  cameraBtn.onclick = toggleCam;

  genPairCodeBtn.onclick = () => withLoading(genPairCodeBtn, genPairCode);
  usePairCodeBtn.onclick = () => withLoading(usePairCodeBtn, async () => {
    const code = pairCodeInput.value.trim();
    const ok = await usePairCode(code);
    if (!ok) return;
    pairCodeInput.value = '';
    pairCodeLabel.textContent = '';
  });

  // Restore local inputs for UX
  usernameInput.value = localStorage.getItem('lastUsername') || '';
  pinInput.value = localStorage.getItem('lastPin') || '';
  usernameInput.addEventListener('input', () => localStorage.setItem('lastUsername', usernameInput.value));
  pinInput.addEventListener('input', () => localStorage.setItem('lastPin', pinInput.value));
</script>

</body>
</html>